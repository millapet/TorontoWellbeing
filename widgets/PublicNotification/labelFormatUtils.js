// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
define("dojo/_base/array dojo/_base/kernel dojo/_base/lang dojo/Deferred dojo/promise/all esri/arcade/arcade esri/arcade/Feature esri/graphic ./generalUtils".split(" "),function(e,q,m,n,r,p,t,u,v){var f={convertPopupToLabelSpec:function(a){var c=[],b,d,g;b=a.description;d=a.fieldInfos;g=a.expressionInfos;a=v.sanitizeNoTags(f.convertBreaksToEOLs(f.convertEndParasToEOLs(b))).trim();a=a.replace(/\{/gi,"${");a=a.replace(/\u00a0/gi," ");a=a.split("\n");a=e.map(a,function(a){var b="";a=a.replace(/\{([^}]+)\}/g,
function(a,c){var f;e.some(d,function(a){var d;if(a.fieldName.toLowerCase()===c.toLowerCase()){f=a.fieldName;d=a.label||a.fieldName;if(!a.hasOwnProperty("label")&&g)for(a=0;a<g.length;a++)d==="expression/"+g[a].name&&(d=g[a].title);b=""===b?d:b+" "+d;return!0}});return f?c?"{"+f+"}":a:c?"{"+c+"}":a});c.push(b);return a.trim()});a.csvHeaderRow=c;return a},createLabelsFromFeatures:function(a,c){var b=new n,d=[],g=[],h=0;c.relationships?(e.forEach(a,function(a){f.objEach(c.relationships,function(b,d){var h=
new n,k=b.relatedQuery,l;g.push(h);l=a.attributes[b.operLayer.layerObject.objectIdField];k.objectIds=[l];b.operLayer.layerObject.queryRelatedFeatures(k,function(b){var g=[];b[l]&&b[l].features&&(b=b[l].features,e.forEach(b,function(b){var e,h,k;e=a.attributes;h="relationships/"+d+"/";f.objEach(b.attributes,function(a,b){k=h+b;e[k]=a});b=new u(a.geometry,null,e);g.push(f.populateLabelLines(b,c))}));h.resolve(g)})})}),r(g).then(function(a){e.forEach(a,function(a){e.forEach(a,function(a){++h;d.push(a)})});
console.log(h+" related address features found");b.resolve(d)})):(e.forEach(a,function(a){d.push(f.populateLabelLines(a,c))}),b.resolve(d));return b},populateLabelLines:function(a,c){var b=[];e.forEach(c,function(d){b.push(f.substitute(d,f.combineFeatureAttributesAndExpressionResolutions(a,c.parsedExpressions),f.useEmptyStringForNull))});return b},substitute:function(a,c,b){var d=q.global;b=b?m.hitch(d,b):function(a){return a};return a.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,function(a,d){if(""===
d)return"$";a=b(c[d],d);if("undefined"===typeof a)throw Error('string.substitute could not find key "'+d+'" in template');return a.toString()})},parseArcadeExpressions:function(a){var c;Array.isArray(a)&&0<a.length&&(c={},e.forEach(a,function(a){c[a.name]=p.parseScript(a.expression)}));return c},initArcadeContext:function(a){var c={vars:{}};c.vars.$feature=t.createFromGraphicLikeObject(a.geometry,a.attributes);return c},combineFeatureAttributesAndExpressionResolutions:function(a,c){var b,d,e;b=m.mixin({},
a.attributes);if(c)for(d in a=f.initArcadeContext(a),c)e=p.executeScript(c[d],a),b["expression/"+d]=e?e.toString():"";return b},convertEndParasToEOLs:function(a){var c=a;a=a.match(/<\/p>/gi);e.forEach(a,function(a){c=c.replace(a,"\n")});return c},convertBreaksToEOLs:function(a){var c=a;a=a.match(/<br\s*\/?>/gi);e.forEach(a,function(a){c=c.replace(a,"\n")});return c},useEmptyStringForNull:function(a){return a?a:""},objEach:function(a,c,b){for(var d in a)a.hasOwnProperty(d)&&c.call(b,a[d],d)}};return f});