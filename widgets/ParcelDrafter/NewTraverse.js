// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.15/esri/copyright.txt and http://www.arcgis.com/apps/webappbuilder/copyright.txt for details.
//>>built
require({cache:{"url:widgets/ParcelDrafter/NewTraverse.html":'\x3cdiv\x3e\r\n    \x3c!-- Traverse grid container--\x3e\r\n    \x3cdiv class\x3d"esriCTNewTraverseContainer"\x3e\r\n        \x3c!-- Traverse grid title--\x3e\r\n        \x3cdiv class\x3d"esriCTNewTraverseLabelDiv"\x3e\r\n            \x3cdiv class\x3d"esriCTGridEmptyLabel"\x3e\r\n                \x26nbsp\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis esriCTGridBearingLabel" title\x3d"${nls.traverseSettings.bearingLabel}"\x3e\r\n                ${nls.traverseSettings.bearingLabel}\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis" title\x3d"${nls.traverseSettings.lengthLabel}"\x3e\r\n                ${nls.traverseSettings.lengthLabel}\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTGridLabels esriCTEllipsis" title\x3d"${nls.traverseSettings.radiusLabel}"\x3e\r\n                ${nls.traverseSettings.radiusLabel}\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid items--\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"traverseGrid" class\x3d"esriCTTraverseGrid"\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid initial entry row--\x3e\r\n        \x3cdiv data-dojo-attach-point\x3d"traverseEntryNode" class\x3d"esriCTEntrtyNodeContent esriCTRow"\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"lineSymbolNode" class\x3d"esriCTSymbolContainer"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"bearingNode" class\x3d"esriCTBearingRow" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.bearingLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"lengthNode" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.lengthLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv data-dojo-attach-point\x3d"radiusNode" data-dojo-type\x3d"dijit/form/ValidationTextBox" aria-label\x3d"${nls.traverseSettings.radiusLabel}"\x3e\r\n            \x3c/div\x3e\r\n            \x3cdiv class\x3d"esriCTAddRow"\x3e\r\n                \x3cdiv data-dojo-attach-point\x3d"addButton" class\x3d"esriCTAddIcon"\r\n                title\x3d"${nls.traverseSettings.addButtonTitle}" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.traverseSettings.addButtonTitle}"\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n        \x3c!-- Traverse grid tools container--\x3e\r\n        \x3cdiv class\x3d"esriCTTraverseTool"\x3e\r\n            \x3cdiv class\x3d"esriCTTraverseToolContainer"\x3e\r\n                \x3c!-- Update rotation point tool--\x3e\r\n                \x3cdiv class\x3d"esriCTTraverseToolIcons ecriCTUpdateRotationPointIcon esriCTCursorPointer" title\x3d"${nls.planSettings.updateRotationPointTooltipText}"\r\n                    data-dojo-attach-point\x3d"updateRotationPointNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.updateRotationPointTooltipText}" aria-pressed\x3d"false"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Screen digitization tool--\x3e\r\n                \x3cdiv class\x3d"esriCTTraverseToolIcons ecriCTLocationIcon esriCTCursorPointer" title\x3d"${nls.planSettings.onScreenDigitizationTooltipText}"\r\n                    data-dojo-attach-point\x3d"screenDigitizationNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.onScreenDigitizationTooltipText}" aria-pressed\x3d"false"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Zoom tool--\x3e\r\n                \x3cdiv class\x3d"esriCTHidden esriCTTraverseToolIcons ecriCTZoomToIcon esriCTCursorPointer" title\x3d"${nls.planSettings.zoomToLocationTooltipText}"\r\n                    data-dojo-attach-point\x3d"zoomToNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.zoomToLocationTooltipText}"\x3e\r\n                \x3c/div\x3e\r\n                \x3c!-- Expand/Collapse grid tool--\x3e\r\n                \x3cdiv class\x3d"esriCTHidden  esriCTTraverseToolIcons esriCTCollapse esriCTCursorPointer" title\x3d"${nls.planSettings.collapseGridTooltipText}"\r\n                    data-dojo-attach-point\x3d"expandCollapseNode" tabindex\x3d"0" role\x3d"button" aria-label\x3d"${nls.planSettings.collapseGridTooltipText}"\x3e\r\n                \x3c/div\x3e\r\n            \x3c/div\x3e\r\n        \x3c/div\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Misclose details container--\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"misCloseDetailsNode"\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Parcel tools (rotation/scale) container--\x3e\r\n    \x3cdiv data-dojo-attach-point\x3d"parcelToolsNode"\x3e\r\n    \x3c/div\x3e\r\n    \x3c!-- Parcel info (polygon layer fields) \x26 save/cancle button container--\x3e\r\n    \x3cdiv class\x3d"esriCTPlanInfoNode" data-dojo-attach-point\x3d"planInfoNode"\x3e\r\n    \x3c/div\x3e\r\n\x3c/div\x3e'}});
define("dojo/_base/declare jimu/BaseWidget dijit/_WidgetsInTemplateMixin dojo/Evented dojo/text!./NewTraverse.html dojo/_base/lang dojo/_base/array dojo/dom-class dojo/dom-construct dojo/dom-style dojo/dnd/Source dojo/on dijit/form/ValidationTextBox ./SymbolSelector ./MiscloseDetails ./ParcelTools ./PlanInfo ./geometryUtils ./utils esri/graphic esri/symbols/jsonUtils esri/layers/GraphicsLayer esri/graphicsUtils dojo/dom-attr dojo/query esri/SpatialReference dojo/keys dijit/focus dijit/TooltipDialog dijit/popup dojo/Deferred esri/geometry/Extent esri/geometry/Point dojo/dom-geometry".split(" "),
function(C,D,E,F,G,f,t,k,q,A,H,p,I,J,K,L,M,h,n,u,v,w,N,g,y,x,l,r,O,B,P,Q,R,z){return C([D,E,F],{baseClass:"jimu-widget-ParcelDrafter",templateString:G,parcelLinesGraphicsLayer:null,parcelPointsGraphicsLayer:null,parcelPolygonGraphicsLayer:null,lineLayerSpatialReference:null,polygonLayerSpatialReference:null,_itemList:[],_nodes:[],_dndContainer:null,startPoint:null,_startPointForNextLine:null,_planSettings:null,_arrayOfAllBoundaryLines:[],_rotationAngle:0,_scaleValue:1,polygonDeleteArr:[],polylineDeleteArr:[],
_popupDialog:null,_popupCoords:null,_setExtentTimer:null,numberFieldTypes:["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"],lengthFieldPlaces:2,radiusFieldPlaces:2,miscloseDistanceFieldPlaces:2,postCreate:function(){this.numberFieldTypes=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];this.polygonDeleteArr=[];this.polylineDeleteArr=[];this._arrayOfAllBoundaryLines=[];this._nodes=[];this._itemList=[];this._setExtentTimer=
null;k.add(this.domNode,"esriCTNewTraverseGrid");this._addGraphicsLayer();this._createTraverseGrid();this._setValidatorForInitialRow();this._handleEventsOnInitialRow();this._symbolSelector=this._createLineSelector(this.lineSymbolNode,null);this.own(p(this.screenDigitizationNode,"click",f.hitch(this,this._onDigitizationButtonClicked)));this.own(p(this.screenDigitizationNode,"keydown",f.hitch(this,function(a){if(a.keyCode===l.ENTER||a.keyCode===l.SPACE)a.preventDefault(),this._onDigitizationButtonClicked()})));
this.own(p(this.updateRotationPointNode,"click",f.hitch(this,this._onUpdateRotationPointButtonClicked)));this.own(p(this.updateRotationPointNode,"keydown",f.hitch(this,function(a){if(a.keyCode===l.ENTER||a.keyCode===l.SPACE)a.preventDefault(),this._onUpdateRotationPointButtonClicked()})));this.own(p(this.zoomToNode,"click",f.hitch(this,this._onZoomButtonClicked)));this.own(p(this.zoomToNode,"keydown",f.hitch(this,function(a){if(a.keyCode===l.ENTER||a.keyCode===l.SPACE)a.preventDefault(),this._onZoomButtonClicked()})));
this.own(p(this.expandCollapseNode,"click",f.hitch(this,this._onExpandCollapseClicked)));this.own(p(this.expandCollapseNode,"keydown",f.hitch(this,function(a){if(a.keyCode===l.ENTER||a.keyCode===l.SPACE)a.preventDefault(),this._onExpandCollapseClicked()})));this.own(p(this.addButton,"click",f.hitch(this,function(){this._addNewItem(!1)})));this.own(p(this.addButton,"keydown",f.hitch(this,function(a){a.keyCode!==l.ENTER&&a.keyCode!==l.SPACE||this._addNewItem(!1)})));this._createMiscloseDetails();this._createParcelTools();
this._createPlanInfo();this._createTooltip();this.config.polylineLayer&&this.config.polylineLayer.popupInfo&&this.config.polylineLayer.popupInfo.fieldInfos&&t.forEach(this.config.polylineLayer.popupInfo.fieldInfos,f.hitch(this,function(a){a.fieldName===this.config.polylineLayer.bearing.name&&a.format&&(n.bearingFieldPlaces=a.format.places);a.fieldName===this.config.polylineLayer.distance.name&&a.format&&(this.lengthFieldPlaces=a.format.places);a.fieldName===this.config.polylineLayer.radius.name&&
a.format&&(this.radiusFieldPlaces=a.format.places)}));this.config.polygonLayer&&this.config.polygonLayer.popupInfo&&this.config.polygonLayer.popupInfo.fieldInfos&&t.forEach(this.config.polygonLayer.popupInfo.fieldInfos,f.hitch(this,function(a){a.fieldName===this.config.polygonLayer.miscloseDistance.name&&a.format&&(this.miscloseDistanceFieldPlaces=a.format.places)}))},_addGraphicsLayer:function(){this.parcelPolygonGraphicsLayer=new w;this.parcelLinesGraphicsLayer=new w;this.parcelPointsGraphicsLayer=
new w;this.rotationPointsGraphicsLayer=new w;this.own(p(this.parcelPointsGraphicsLayer,"click",f.hitch(this,function(a){k.contains(this.updateRotationPointNode,"esriCTEnableButton")&&(this._setRotationPoint(a.graphic.attributes.rowIndex,a.graphic.geometry),this._showRotationPoint())})));this.map.addLayer(this.parcelPolygonGraphicsLayer);this.map.addLayer(this.parcelLinesGraphicsLayer);this.map.addLayer(this.parcelPointsGraphicsLayer);this.map.addLayer(this.rotationPointsGraphicsLayer)},_setValidatorForInitialRow:function(){this.bearingNode.validator=
f.hitch(this,function(a){return this._bearingValidator(a,["*","*tb"])});this.bearingNode.invalidMessage=this.nls.newTraverse.invalidBearingMessage;this.lengthNode.validator=f.hitch(this,function(a){if("*"===a&&this._itemList&&0<this._itemList.length)return!0;if(""===this.radiusNode.get("value")&&0>parseFloat(a))return this.lengthNode.invalidMessage=this.nls.newTraverse.negativeLengthMessage,!1;this.lengthNode.invalidMessage=this.nls.newTraverse.invalidLengthMessage;return this._lengthValidator(a)});
this.lengthNode.invalidMessage=this.nls.newTraverse.invalidLengthMessage;this.radiusNode.validator=f.hitch(this,function(a){var b;if("*"===a&&this._itemList&&0<this._itemList.length)return!0;b=this._radiusValidator(a);if(""!==a)if((a=this.lengthNode.isValid())&&b){if(!this._validateLengthRadiusProportion(b,a))return null;b&&(a=this.lengthNode.value,this.lengthNode.reset(),this.lengthNode.set("value",a))}else b=null;return b});this.radiusNode.invalidMessage=this.nls.newTraverse.invalidRadiusMessage},
_bearingValidator:function(a,b){return-1!==b.indexOf(a)&&this._itemList&&0<this._itemList.length?!0:this._validateBearing(a,b)},_lengthValidator:function(a,b){return""===a||"0"===a||0===a?!1:this._validateLength(a,b)},_radiusValidator:function(a,b){return""===a?!0:this._validateLength(a,b)},_handleEventsOnInitialRow:function(){this.own(p(this.bearingNode,"keypress",f.hitch(this,this._bearingValueEntered)));this.own(p(this.lengthNode,"keypress",f.hitch(this,this._lengthValueEntered)));this.own(p(this.radiusNode,
"keypress",f.hitch(this,this._radiusValueEntered)))},_copyPrevValue:function(a){switch(a){case "Bearing":a=this.bearingNode.get("value");"*"===a&&0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].BearingConversions?this._getBearingAccordingToPlanSettings(this._itemList[this._itemList.length-1].BearingConversions):this._itemList[this._itemList.length-1].Bearing,this.bearingNode.set("value",a));break;case "Length":a=this.lengthNode.get("value");"*"===a&&0<this._itemList.length&&(a=
"radiusAndArcLength"===this._planSettings.circularCurveParameters&&this._itemList[this._itemList.length-1].ArcLengthConversions?this._itemList[this._itemList.length-1].ArcLengthConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].LengthConversions?this._itemList[this._itemList.length-1].LengthConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].Length,this.lengthNode.set("value",a));break;case "Radius":a=this.radiusNode.get("value"),
"*"===a&&0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].RadiusConversions?this._itemList[this._itemList.length-1].RadiusConversions[this._planSettings.distanceAndLengthUnits]:this._itemList[this._itemList.length-1].Radius,this.radiusNode.set("value",a))}},_bearingValueEntered:function(a){a=a.charCode||a.keyCode;a===l.ENTER||a===l.TAB?(this.bearingNode.get("value"),this._copyPrevValue("Bearing"),a===l.ENTER&&this.bearingNode.isValid()?r.focus(this.lengthNode):this.bearingNode.validate(!1)):
setTimeout(f.hitch(this,function(){this.bearingNode.validate(!1)}),100)},_lengthValueEntered:function(a){a=a.charCode||a.keyCode;a===l.ENTER||a===l.TAB?(this.lengthNode.get("value"),this._copyPrevValue("Length"),a===l.ENTER&&this.lengthNode.isValid()?r.focus(this.radiusNode):this.lengthNode.validate(!1)):setTimeout(f.hitch(this,function(){this.lengthNode.validate(!1)}),100)},_radiusValueEntered:function(a){(a.charCode||a.keyCode)===l.ENTER?(a=this.radiusNode.get("value"),this._copyPrevValue("Radius"),
""===a||this.radiusNode.isValid()?this.bearingNode.isValid()?this.lengthNode.isValid()?(this._addNewItem(),r.focus(this.bearingNode)):(this.lengthNode.validate(!1),r.focus(this.lengthNode)):(this.bearingNode.validate(!1),r.focus(this.bearingNode)):this.radiusNode.validate(!1)):setTimeout(f.hitch(this,function(){this.radiusNode.validate(!1)}),100)},_validateBearing:function(a){return(a=n.categorizeBearingFormat(a,this._planSettings))?a:null},_validateLength:function(a,b){switch(b){case "feets":a=n.categorizeLengthFormatForFeet(a);
break;case "meters":a=n.categorizeLengthFormat(a,"meters");break;case "uSSurveyFeet":a=n.categorizeLengthFormat(a,"uSSurveyFeet");break;default:a=n.categorizeLengthFormat(a,this._planSettings.distanceAndLengthUnits)}return a?a:null},_validateLengthRadiusProportion:function(a,b){return a&&b&&(a=a[this._planSettings.distanceAndLengthUnits],b=b[this._planSettings.distanceAndLengthUnits],0!==a&&(a=2*parseFloat(Math.abs(a)),"radiusAndArcLength"===this._planSettings.circularCurveParameters&&(a*=Math.PI),
a<parseFloat(Math.abs(b))))?null:!0},_getValidatedValues:function(a,b,c){var d={},e;a?(d=a,b&&("Bearing"!==b&&d.BearingConversions&&(d.Bearing=this._getBearingAccordingToPlanSettings(d.BearingConversions)),"Length"!==b&&d.LengthConversions&&(d.Length=d.LengthConversions[this._planSettings.distanceAndLengthUnits]),"Radius"!==b&&d.RadiusConversions&&(d.Radius=d.RadiusConversions[this._planSettings.distanceAndLengthUnits]),"Bearing"===b&&"*tb"===d.Bearing.toString().toLowerCase()&&0<this._itemList.length&&
0!==c&&(d.isTB=!0))):(this._copyPrevValue("Bearing"),this._copyPrevValue("Length"),this._copyPrevValue("Radius"),d.LineSymbol=this._symbolSelector.selectedSymbol,d.Bearing=this.bearingNode.get("value"),d.Length=this.lengthNode.get("value"),d.Radius=this.radiusNode.get("value"),"*tb"===d.Bearing.toString().toLowerCase()&&0<this._itemList.length?d.isTB=!0:d.isTB=!1);if(""!==f.trim(d.Bearing.toString())&&""!==f.trim(d.Length.toString())&&((b=this._validateBearing(d.Bearing))||d.isTB)){d.BearingConversions=
b;if(""===f.trim(d.Length.toString())&&""===f.trim(d.Radius.toString()))return null;if(""!==f.trim(d.Length.toString()))if((b=this._validateLength(d.Length))&&0!==b.meters){if(""!==f.trim(d.Radius.toString()))if(e=this._validateLength(d.Radius)){if(!this._validateLengthRadiusProportion(e,b))return null;d.RadiusConversions=e}else return null;else{if(0>parseInt(b.meters,10))return null;d.RadiusConversions=null}d.LengthConversions=b}else return null;d.RadiusConversions&&(d=this._createValuesForArc(d));
d.isTB&&(a=a&&!isNaN(c)?this._itemList[c-1]:this._itemList[this._itemList.length-1],d=this._setTangentBearing(d,a))}else return null;return d},_setTangentBearing:function(a,b){var c,d;d=f.clone(this._planSettings);d.directionOrAngleType="northAzimuth";d.directionOrAngleUnits="decimalDegree";c=b.BearingConversions.naDD;b.RadiusConversions&&0!==b.RadiusConversions.meters&&(c=h.chordBearingToTangentBearing(c,b.RadiusConversions.meters,b.ChordLengthConversions.meters));a.RadiusConversions&&0!==a.RadiusConversions.meters?
(c=h.tangentBearingToChordBearing(c,a.RadiusConversions.meters,a.ChordLengthConversions.meters),a.Bearing=c,a.BearingConversions=n.categorizeBearingFormat(a.Bearing,d)):b.RadiusConversions&&0!==b.RadiusConversions.meters?(a.Bearing=c,a.BearingConversions=n.categorizeBearingFormat(a.Bearing,d)):(a.Bearing=b.Bearing,a.BearingConversions=f.clone(b.BearingConversions));return a},_updateTBFromIndex:function(a){var b;for(b=!1;a<this._itemList.length;a++)if(this._itemList[a]&&this._itemList[a].isTB)this._itemList[a]=
this._setTangentBearing(this._itemList[a],this._itemList[a-1]),b=!0;else break;return b},_onZoomButtonClicked:function(){this._setExtentToLayer(this.parcelLinesGraphicsLayer,!0)},_onExpandCollapseClicked:function(){k.toggle(this.traverseGrid,"esriCTHidden");k.contains(this.expandCollapseNode,"esriCTExpand")?(g.set(this.expandCollapseNode,"title",this.nls.planSettings.collapseGridTooltipText),k.replace(this.expandCollapseNode,"esriCTCollapse","esriCTExpand"),g.set(this.expandCollapseNode,"aria-expanded",
!0)):(g.set(this.expandCollapseNode,"title",this.nls.planSettings.expandGridTooltipText),k.replace(this.expandCollapseNode,"esriCTExpand","esriCTCollapse"),g.set(this.expandCollapseNode,"aria-expanded",!1))},setRotation:function(a){var b;b=this.startPoint;this._rotationPointInfo&&this._rotationPointInfo.rotationPoint&&(b=this._rotationPointInfo.rotationPoint);a=h.getRotationAngleBetweenPoints(b,a);0<this._itemList.length&&(b=0,this._rotationPointInfo&&this._rotationPointInfo.rotationPointIndex<this._itemList.length&&
(b=this._rotationPointInfo.rotationPointIndex),a-=this._itemList[b].BearingConversions.naDDRound);360===a&&(a=0);this._parcelToolInstance.setRotation(a)},setScaling:function(a){a=h.getScaleDistanceBetweenPoints(this.startPoint,a);this.distance?(a/=this.distance,.1>a&&(a=.1),this._parcelToolInstance.setScale(a)):this.distance=a},_addNewItem:function(a){var b,c;(b=this._getValidatedValues())?(a&&this._rotationAngle&&(c=b.BearingConversions.naDD-this._rotationAngle,c=this.getAngleFromDDTOQB(360<=c?c%
360:c),b.Bearing=c,b.BearingConversions=this._validateBearing(c)),c=f.trim(b.Radius.toString()),this._itemList.push(b),this._createRow(b,this._itemList.length-1),r.focus(this.bearingNode),this._resetEntryRow(a),""===c||"0"===c||0===c?this._drawStraightLine(b,!0):this._drawArc(b,!0),this._showHideTraverseTools(),this.appliedCompassRule&&this.setParcelClosure()):this.bearingNode.isValid()?""!==this.lengthNode.get("value")&&this.lengthNode.isValid()?""===this.radiusNode.get("value")||this.radiusNode.isValid()||
(r.focus(this.radiusNode),this.radiusNode.validate(!1)):(r.focus(this.lengthNode),this.lengthNode.validate(!1)):(r.focus(this.bearingNode),this.bearingNode.validate(!1))},_createValuesForArc:function(a){var b;a.RadiusConversions?(b=a.RadiusConversions.meters,"radiusAndArcLength"===this._planSettings.circularCurveParameters?(a.ArcLength=a.LengthConversions.meters,a.ArcLengthConversions=f.clone(a.LengthConversions),a.ChordLength=h.getChordLengthFromArcLength(a.ArcLength,b),a.ChordLengthConversions=
this._validateLength(a.ChordLength,"meters")):(a.ChordLength=a.LengthConversions.meters,a.ChordLengthConversions=f.clone(a.LengthConversions),a.ArcLength=h.getArcLengthFromChordLength(a.ChordLength,b),a.ArcLengthConversions=this._validateLength(a.ArcLength,"meters"))):("radiusAndArcLength"===this._planSettings.circularCurveParameters&&a.ArcLengthConversions&&(a.Length=a.ArcLength,a.LengthConversions=f.clone(a.ArcLengthConversions)),a.ChordLength=0,a.ChordLengthConversions=null,a.ArcLength=0,a.ArcLengthConversions=
null);return a},_onDigitizationButtonClicked:function(){k.toggle(this.screenDigitizationNode,"esriCTEnableButton");k.contains(this.screenDigitizationNode,"esriCTEnableButton")?(g.set(this.screenDigitizationNode,"aria-pressed","true"),this.emit("activateDigitizationTool"),this.deActivateUpdateRotationPointTool()):(g.set(this.screenDigitizationNode,"aria-pressed","false"),this.emit("deActivateDigitizationTool"))},_onUpdateRotationPointButtonClicked:function(){k.toggle(this.updateRotationPointNode,"esriCTEnableButton");
k.contains(this.updateRotationPointNode,"esriCTEnableButton")?(g.set(this.updateRotationPointNode,"aria-pressed","true"),this.emit("activateUpdateRotationPointTool"),this.deActivateDigitizationTool()):(g.set(this.updateRotationPointNode,"aria-pressed","false"),this.emit("deActivateUpdateRotationPointTool"))},_createMiscloseDetails:function(){this._misCloseDetailsInstance=new K({nls:this.nls,config:this.config,appConfig:this.appConfig,numberFieldTypes:this.numberFieldTypes,validateNumericField:this.validateNumericField},
q.create("div",{},this.misCloseDetailsNode));this._misCloseDetailsInstance.setMiscloseDetails(null)},_createParcelTools:function(){this._parcelToolInstance=new L({nls:this.nls,config:this.config},q.create("div",{},this.parcelToolsNode));this.own(this._parcelToolInstance.on("rotateGeometries",f.hitch(this,function(a){a!==this._rotationAngle&&(this._rotationAngle=a,this._rotationPointInfo&&this._rotationPointInfo.rotationPoint?this._updateStartPointFromRotationPoint():this._itemList&&0<this._itemList.length&&
this.setStartPoint(this.startPoint))})));this.own(this._parcelToolInstance.on("scaleGeometries",f.hitch(this,function(a){a!==this._scaleValue&&(this._scaleValue=a,this._rotationPointInfo&&this._rotationPointInfo.rotationPoint?this._updateStartPointFromRotationPoint():this._itemList&&0<this._itemList.length&&this.setStartPoint(this.startPoint))})));this.own(this._parcelToolInstance.on("toggleRotating",f.hitch(this,function(a){this.emit("toggleRotating",a)})));this.own(this._parcelToolInstance.on("toggleScaling",
f.hitch(this,function(a){this.emit("toggleScaling",a)})))},_createPlanInfo:function(){this._planInfoInstance=new M({map:this.map,nls:this.nls,config:this.config,loading:this.loading,numberFieldTypes:this.numberFieldTypes,validateNumericField:this.validateNumericField,geometryService:this.geometryService,parcelPolygonGraphicsLayer:this.parcelPolygonGraphicsLayer,parcelLinesGraphicsLayer:this.parcelLinesGraphicsLayer,polylineLayerUnit:h.getUnitValueForSR(this.lineLayerSpatialReference),polygonLayerUnit:h.getUnitValueForSR(this.polygonLayerSpatialReference),
widgetDomNode:this.widgetDomNode},q.create("div",{},this.planInfoNode));this.own(this._planInfoInstance.on("cancelTraversedParcel",f.hitch(this,function(){this.emit("cancelTraverse")})));this.own(this._planInfoInstance.on("showMessage",f.hitch(this,function(a){this._showMessage(a)})));this.own(this._planInfoInstance.on("showParcelSavedAndDeleteMsg",f.hitch(this,function(a){this._showParcelSavedAndDeleteMsg(a)})));this.own(this._planInfoInstance.on("saveTraversedParcel",f.hitch(this,function(){var a;
this.closePopup();if(this._itemList&&0<this._itemList.length){var b;b=this._misCloseDetailsInstance.traverseStatedArea.get("value").trim();a=this._planInfoInstance.validateParcelDetails(b);a.status?(""===this._misCloseDetailsInstance.traverseStatedArea.get("value")&&(b=null),a={},a.itemList=this._itemList,a.statedArea=b,a.rotation=this._rotationAngle,a.scale=this._scaleValue,a.appliedCompassRule=this.appliedCompassRule,a.miscloseDetails=this._misCloseDetailsInstance.getMiscloseDetails(),a.polygonDeleteArr=
this.polygonDeleteArr,a.polylineDeleteArr=this.polylineDeleteArr,a.planSettings=this._planSettings,this._planInfoInstance.saveData(a)):this._showMessage(a.message)}else this._showMessage(this.nls.newTraverse.enterValidParcelInfoMessage)})));this.own(this._planInfoInstance.on("displayMainPageAfterSave",f.hitch(this,function(){this.emit("displayMainPageAfterSave",!1)})))},_createTraverseGrid:function(){var a;this._nodes=[];q.empty(this.traverseGrid);this._dndContainer=new H(this.traverseGrid,{skipForm:!0,
singular:!0});this._dndContainer.copyState=function(){return!1};for(a=0;a<this._itemList.length;a++)this._createRow(this._itemList[a],a);this.own(this._dndContainer.on("DndDrop",f.hitch(this,this._onDndDrop)));this._dndContainer.insertNodes(!1,this._nodes)},_createFieldInputs:function(a,b,c,d){var e=new I({value:b,"class":c?c:""});e.placeAt(a);"esriCTBearingRow"===c?(g.set(e,"aria-label",this.nls.traverseSettings.bearingLabel),e.validator=f.hitch(this,function(a){"*tb"!==a&&"*"===a.charAt(0)&&(a=
a.slice(1));return this._bearingValidator(a,["*tb"])}),e.invalidMessage=this.nls.newTraverse.invalidBearingMessage):"esriCTLengthRow"===c?(g.set(e,"aria-label",this.nls.traverseSettings.lengthLabel),e.validator=f.hitch(this,this._lengthValidator),e.invalidMessage=this.nls.newTraverse.invalidLengthMessage):"esriCTRadiusRow"===c&&(g.set(e,"aria-label",this.nls.traverseSettings.radiusLabel),e.validator=f.hitch(this,this._radiusValidator),e.invalidMessage=this.nls.newTraverse.invalidRadiusMessage);this.own(p(e,
"blur",f.hitch(this,function(){var b=parseInt(g.get(a,"rowIndex"),10);this._updateParcelValues(e,b,d)})));this.own(p(e,"keypress",f.hitch(this,function(b){(b.charCode||b.keyCode)===l.ENTER&&(b=parseInt(g.get(a,"rowIndex"),10),this._updateParcelValues(e,b,d));setTimeout(f.hitch(this,function(){e.validate(!1)}),100)})))},_createRow:function(a,b){var c,d;c=q.create("div",{"class":"dojoDndItem esriCTRow",rowIndex:b});d=q.create("div",{rowIndex:b},c);this._createLineSelector(d,a.LineSymbol,b);d=this._getBearingAccordingToPlanSettings(a.BearingConversions);
a.isTB&&(d="*"+d);this._createFieldInputs(c,d,"esriCTBearingRow");a.RadiusConversions?(d=this._getRoundedValue(a.RadiusConversions,"Radius"),a="radiusAndArcLength"===this._planSettings.circularCurveParameters?this._getRoundedValue(a.ArcLengthConversions,"Length"):this._getRoundedValue(a.ChordLengthConversions,"Length")):(d="",a=this._getRoundedValue(a.LengthConversions,"Length"));this._createFieldInputs(c,a,"esriCTLengthRow");this._createFieldInputs(c,d,"esriCTRadiusRow");this._createDeleteButton(c,
b);this._nodes.push(c);this._dndContainer.clearItems();this._dndContainer.insertNodes(!1,this._nodes)},_createLineSelector:function(a,b,c){var d;d=new J({hideOnSelect:!0,symbolData:this.config.lineTypes,tabindex:"0","aria-label":this.nls.newTraverse.lineTypeLabel,role:"button","aria-haspopup":"true"},a);k.add(d.domNode,"esriCTSymbolContainer");b?(d.selectSymbol(b),g.set(d.domNode,"rowIndex",c),d.onSelect=f.hitch(this,function(a){var b;b=parseInt(g.get(d.domNode,"rowIndex"),10);this._itemList[b].LineSymbol=
a;this.setStartPoint(this.startPoint)})):d.setDefault();return d},_createDeleteButton:function(a,b){var c;c=q.create("div",{"class":"esriCTDeleteRow"},a);b=q.create("div",{"class":"esriCTDeleteIcon",rowIndex:b,title:this.nls.traverseSettings.deleteButtonTitle,tabindex:"0",role:"button","aria-label":this.nls.traverseSettings.deleteButtonTitle},c);this.own(p(b,"click",f.hitch(this,function(b){b=parseInt(g.get(b.currentTarget,"rowIndex"),10);this._deleteRow(a,b)})));this.own(p(b,"keydown",f.hitch(this,
function(b){if(b.keyCode===l.ENTER||b.keyCode===l.SPACE)b=parseInt(g.get(b.currentTarget,"rowIndex"),10),this._deleteRow(a,b),r.focus(this.bearingNode)})))},_deleteRow:function(a,b){var c;if(this._itemList.length){this._dndContainer.delItem(a.id);q.destroy(a);this._nodes.splice(b,1);this._itemList.splice(b,1);this._dndContainer.sync();this._updateRowIndexes();if(this._itemList[b]&&this._itemList[b].isTB){if(1===this._itemList.length||0===b)this._itemList[0].isTB=!1,b++;1<this._itemList.length&&(c=
this._updateTBFromIndex(b))}this.appliedCompassRule?this.setParcelClosure(!0,!0):this.setStartPoint(this.startPoint,!0);c&&this._reGenerateTraverseGrid();this._showHideTraverseTools()}},_updateRowIndexes:function(){var a;a=y(".esriCTRow",this.traverseGrid);t.forEach(a,f.hitch(this,function(a,c){var b;g.set(a,"rowIndex",c);(b=y(".esriCTDeleteIcon",a)[0])&&g.set(b,"rowIndex",c);(a=y(".esriCTSymbolContainer",a)[0])&&g.set(a,"rowIndex",c)}))},_onDndDrop:function(){var a,b=[],c;this._dndContainer.sync();
a=this._dndContainer.getAllNodes();a.forEach(f.hitch(this,function(a){a=parseInt(g.get(a,"rowIndex"),10);b.push(this._itemList[a])}));this._nodes=a;this._itemList=[];this._itemList=b;this._updateRowIndexes();for(a=0;a<this._itemList.length;a++)0===a&&this._itemList[a].isTB&&(this._itemList[a].isTB=!1,c=!0),this._itemList[a]&&this._itemList[a].isTB&&(this._itemList[a]=this._setTangentBearing(this._itemList[a],this._itemList[a-1]),c=!0);this.setStartPoint(this.startPoint,!0);c&&this._reGenerateTraverseGrid()},
_updateParcelValues:function(a,b,c){var d,e,m,h=!1,g;if(d=this._itemList[b])if(m=(m=a.get("value"))?f.trim(m.toString()):"",k.contains(a.domNode,"esriCTBearingRow")&&String(this._getBearingAccordingToPlanSettings(d.BearingConversions))!==m?(e="Bearing",d.Bearing=m,h=!0,-1===m.indexOf("*")&&(d.isTB=!1)):k.contains(a.domNode,"esriCTLengthRow")&&String(this._getRoundedValue(d.LengthConversions,"Length"))!==m?(e="Length",d.Length=m,h=!0):k.contains(a.domNode,"esriCTRadiusRow")&&String(d.Radius)!==m&&
(d.RadiusConversions?String(this._getRoundedValue(d.RadiusConversions,"Radius"))!==m&&(e="Radius",d.Radius=m,h=!0):(e="Radius",d.Radius=m,h=!0)),h)if(m=this._getValidatedValues(d,e,b)){if("Bearing"===e?(e=this._getBearingAccordingToPlanSettings(m.BearingConversions),d.Bearing=this._getBearingAccordingToPlanSettings(m.BearingConversions,!0),d.isTB&&(e="*"+e),a.set("value",e),g=this._updateTBFromIndex(b+1)):"Length"===e?(e=this._getRoundedValue(d.LengthConversions,"Length"),d.Length=d.LengthConversions[this._planSettings.distanceAndLengthUnits],
d.RadiusConversions&&(d=this._createValuesForArc(d)),a.set("value",e),g=this._updateTBFromIndex(b)):"Radius"===e&&(d.RadiusConversions?(d.Radius=d.RadiusConversions[this._planSettings.distanceAndLengthUnits],e=this._getRoundedValue(d.RadiusConversions,"Radius")):e=d.Radius="",d=this._createValuesForArc(d),a.set("value",e),g=this._updateTBFromIndex(b)),this.appliedCompassRule?this.setParcelClosure(!0,!0):this.setStartPoint(this.startPoint,!0),g||c)this._reGenerateTraverseGrid(),c&&this._popupCoords&&
this._openPopup(this._popupCoords)}else this._updateValues(d,e,a)},_updateValues:function(a,b,c){var d;"Bearing"===b?(a.Bearing=this._getBearingAccordingToPlanSettings(a.BearingConversions,!0),d=this._getBearingAccordingToPlanSettings(a.BearingConversions)):"Length"===b?(a.Length=a.LengthConversions[this._planSettings.distanceAndLengthUnits],d=this._getRoundedValue(a.LengthConversions,"Length")):"Radius"===b&&(a.RadiusConversions?(a.Radius=a.RadiusConversions[this._planSettings.distanceAndLengthUnits],
d=this._getRoundedValue(a.RadiusConversions,"Radius")):d=a.Radius="");c.set("value",d)},_showHideTraverseTools:function(){this._itemList&&0<this._itemList.length?(k.remove(this.expandCollapseNode,"esriCTHidden"),k.remove(this.zoomToNode,"esriCTHidden")):(k.add(this.expandCollapseNode,"esriCTHidden"),k.add(this.zoomToNode,"esriCTHidden"))},_getBearingAccordingToPlanSettings:function(a,b){if("northAzimuth"===this._planSettings.directionOrAngleType&&"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?
a.naDD:a.naDDRound;if("northAzimuth"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.naDMS;if("southAzimuth"===this._planSettings.directionOrAngleType&&"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?a.saDD:a.saDDRound;if("southAzimuth"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.saDMS;if("quadrantBearing"===this._planSettings.directionOrAngleType&&
"decimalDegree"===this._planSettings.directionOrAngleUnits)return b?a.qb3DD:a.qb3DDRound;if("quadrantBearing"===this._planSettings.directionOrAngleType&&"degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits)return a.qb3DMS},_getRoundedValue:function(a,b){var c;a=a[this._planSettings.distanceAndLengthUnits];switch(b){case "Length":c=this.lengthFieldPlaces;break;case "Radius":c=this.radiusFieldPlaces;break;case "MiscloseDistance":c=this.miscloseDistanceFieldPlaces}return n.honourPopupRounding(c,
a)},_resetEntryRow:function(a){this.bearingNode.set("value","");this.lengthNode.set("value","");this.radiusNode.set("value","");this.bearingNode.reset();this.lengthNode.reset();this.radiusNode.reset();0<this._itemList.length&&(a=this._itemList[this._itemList.length-1].isTB?"*tb":a?this._getBearingAccordingToPlanSettings(this._itemList[this._itemList.length-1].BearingConversions):this._itemList[this._itemList.length-1].Bearing,this.bearingNode.set("value",a),this.bearingNode.textbox.setSelectionRange(0,
a.length))},_reGenerateTraverseGrid:function(){this._dndContainer&&(this._dndContainer.destroy(),this._dndContainer=null);q.empty(this.traverseGrid);this._createTraverseGrid()},_showRotationPoint:function(){var a,b,c=this.startPoint;this.config.startOrRotaionSymbol?b=v.fromJson(this.config.startOrRotaionSymbol):(a={color:[136,136,136,255],size:11.25,angle:0,xoffset:0,yoffset:0,type:"esriSMS",style:"esriSMSCircle",outline:{color:[29,29,53,255],width:.75,type:"esriSLS",style:"esriSLSSolid"}},b=v.fromJson(a));
this._rotationPointInfo&&this._rotationPointInfo.rotationPoint&&(c=this._rotationPointInfo.rotationPoint);4326!==this.map.spatialReference.wkid?h.getProjectedGeometry(c,this.map.spatialReference,this.geometryService).then(f.hitch(this,function(a){a&&(a=new u(a),a.setSymbol(b),this.rotationPointsGraphicsLayer.clear(),this.rotationPointsGraphicsLayer.add(a))})):(a=new u(c),a.setSymbol(b),this.rotationPointsGraphicsLayer.clear(),this.rotationPointsGraphicsLayer.add(a))},resetRotationPoint:function(a){this._setRotationPoint(0,
a)},_setRotationPoint:function(a,b){var c=b;b=new x(4326);h.getProjectedGeometry(c,b,this.geometryService).then(f.hitch(this,function(b){c=b;this._rotationPointInfo={rotationPointIndex:a,rotationPoint:c}}))},_updateStartPointFromRotationPoint:function(){var a=this._rotationPointInfo.rotationPoint,b=this._rotationPointInfo.rotationPointIndex;if(null!==this._rotationAngle){for(--b;0<=b;b--){var c,d;d=this._itemList[b];var e=Number(d.BearingConversions.naDD)+this._rotationAngle;c=d.LengthConversions.meters;
this._scaleValue&&(c*=this._scaleValue);e=n.getSouthAzimuthFromNorthAzimuth(e);""===d.Radius||"0"===d.Radius||0===d.Radius?a=h.getDestinationPoint(a,e,c):(c=d.RadiusConversions.meters,d=d.ChordLengthConversions.meters,this._scaleValue&&(c*=this._scaleValue,d*=this._scaleValue),a=this.getArcInfo(a,e,c,d),a=a.endPoint)}this.setStartPoint(a)}},_reDrawParcel:function(){this.parcelLinesGraphicsLayer.clear();this.parcelPointsGraphicsLayer.clear();this._arrayOfAllBoundaryLines=[];this._drawPoint(this.startPoint);
t.forEach(this._itemList,f.hitch(this,function(a){""===a.Radius||"0"===a.Radius||0===a.Radius?this._drawStraightLine(a,!1):this._drawArc(a,!1)}));this._setExtentToLayer(this.parcelLinesGraphicsLayer);this.setParcelClosure()},setStartPoint:function(a,b,c,d){var e=new x(4326);h.getProjectedGeometry(a,e,this.geometryService).then(f.hitch(this,function(e){c&&this._rotationPointInfo?(this._setRotationPoint(this._rotationPointInfo.rotationPointIndex,e),this._updateStartPointFromRotationPoint()):(this.startPoint=
e,b&&this.resetRotationPoint(this.startPoint),this._showRotationPoint(),this._startPointForNextLine=f.clone(e),this._orgStartPointForNextLine=f.clone(e),this.appliedCompassRule=!1,0<this._itemList.length?this._reDrawParcel():(this.parcelPointsGraphicsLayer.clear(),this.parcelLinesGraphicsLayer.clear(),this._arrayOfAllBoundaryLines=[],this._drawPoint(a,d)))}))},_addProjectedGraphic:function(a,b,c,d,e){var m,g={};g.rowIndex=a.graphics.length;b.attributes=g;4326!==this.map.spatialReference.wkid?h.getProjectedGeometry(b.geometry,
this.map.spatialReference,this.geometryService).then(f.hitch(this,function(f){f&&(m=new u(f),m.setAttributes(g),m.setSymbol(b.symbol),a.add(m),e&&a.graphics&&0<a.graphics.length&&this.map.centerAt(a.graphics[0].geometry),c&&(this._setExtentToLayer(a),d&&this.setParcelClosure()))})):(a.add(b),e&&a.graphics&&0<a.graphics.length&&this.map.centerAt(a.graphics[0].geometry),c&&(this._setExtentToLayer(a),d&&this.setParcelClosure()))},_drawPoint:function(a,b){a=new u(a,v.fromJson(this.config.pointSymbol));
this._addProjectedGraphic(this.parcelPointsGraphicsLayer,a,!1,!1,b)},_drawLineAndEndPoint:function(a,b,c,d){var e;e=!0;a?(b=h.getLineBetweenPoints(b))?(c=new u(b,v.fromJson(c.LineSymbol.symbol)),this._addProjectedGraphic(this.parcelLinesGraphicsLayer,c,d,!0),this._startPointForNextLine=f.clone(a),this.appliedCompassRule&&this.parcelLinesGraphicsLayer.graphics.length===this._itemList.length&&(e=!1),e&&this._drawPoint(a)):this._showMessage(this.nls.newTraverse.unableToDrawLineMessage):this._showMessage(this.nls.newTraverse.invalidEndPointMessage)},
setInfoForCalculatingMisclose:function(a,b,c){a.startPoint=f.clone(this._orgStartPointForNextLine);a.endpoint=f.clone(b);c=h.getLineBetweenPoints(c);if(a.LineSymbol.type===this.config.BoundaryLineType)for(var d=0;d<c.paths.length;d++)this._arrayOfAllBoundaryLines.push(c.paths[d]);this._orgStartPointForNextLine=f.clone(b);return a},getArcInfo:function(a,b,c,d){var e,f,g;e=h.getDestinationPoint(a,b,Math.abs(d));f=Math.abs(d)/2;g=h.getDestinationPoint(a,b,f);a={distance:d,radius:c,initBearing:b,chordMidPoint:g,
centerAndChordDistance:Math.sqrt(Math.abs(c*c-f*f)),chordEndPoint:e,chordStartPoint:a};b=h.getArcParam(a);b.startAngle=b.startAngle>b.endAngle?b.startAngle-360:b.startAngle;b=h.getPointsForArc(b.startAngle,b.endAngle,b.centerPoint,c);0===b.length&&(b.push(a.chordStartPoint),b.push(a.chordEndPoint));0>c&&b.reverse();return{endPoint:e,arcGeometryPointsArray:b}},_drawStraightLine:function(a,b){var c,d,e;c=a.BearingConversions.naDD;d=a.LengthConversions.meters;if(a.adjustedValues&&this.adjustPoints){c=
a.adjustedValues.adjustedBearing;if("S"===a.BearingConversions.qb3DDRound.charAt(0)||0>a.adjustedValues.lat)c=a.adjustedValues.adjustedBearingNADD;d=a.adjustedValues.adjustedLength;this.appliedCompassRule=!0}this._rotationAngle&&(c=Number(c)+this._rotationAngle);this._scaleValue&&(d*=this._scaleValue);e=h.getDestinationPoint(this._orgStartPointForNextLine,a.BearingConversions.naDD,a.LengthConversions.meters);c=h.getDestinationPoint(this._startPointForNextLine,c,d);a=this.setInfoForCalculatingMisclose(a,
e,[this._orgStartPointForNextLine,e]);this._drawLineAndEndPoint(c,[this._startPointForNextLine,c],a,b)},_drawArc:function(a,b){var c,d,e,f;e=a.BearingConversions.naDD;c=a.RadiusConversions.meters;d=a.ChordLengthConversions.meters;if(a.adjustedValues&&this.adjustPoints){e=a.adjustedValues.adjustedBearing;if("S"===a.BearingConversions.qb3DDRound.charAt(0)||0>a.adjustedValues.lat)e=a.adjustedValues.adjustedBearingNADD;d=a.adjustedValues.adjustedLength;0>a.ChordLengthConversions.meters&&(d*=-1);this.appliedCompassRule=
!0}this._rotationAngle&&(e=Number(e)+this._rotationAngle);this._scaleValue&&(d*=this._scaleValue,c*=this._scaleValue);f=this.getArcInfo(this._orgStartPointForNextLine,a.BearingConversions.naDD,a.RadiusConversions.meters,a.ChordLengthConversions.meters);a=this.setInfoForCalculatingMisclose(a,f.endPoint,f.arcGeometryPointsArray);c=this.getArcInfo(this._startPointForNextLine,e,c,d);this._drawLineAndEndPoint(c.endPoint,c.arcGeometryPointsArray,a,b)},_setExtentToLayer:function(a,b){this._setExtentTimer&&
clearTimeout(this._setExtentTimer);this._setExtentTimer=setTimeout(f.hitch(this,function(){var c;0<a.graphics.length&&(c=N.graphicsExtent(a.graphics),!b&&this.map.extent.contains(c)||this.map.setExtent(c.expand(1.5)))}),200)},_showMessage:function(a){this.emit("showMessage",a)},updateAccordingToPlanSettings:function(a){this._planSettings=a;this.bearingNode.set("placeHolder",this._getAbbreviatedUnits(a.directionOrAngleUnits));this.lengthNode.set("placeHolder",this._getAbbreviatedUnits(a.distanceAndLengthUnits));
this.radiusNode.set("placeHolder",this._getAbbreviatedUnits(a.distanceAndLengthUnits));this._reGenerateTraverseGrid();this._misCloseDetailsInstance&&(a=this._misCloseDetailsInstance.getMiscloseDetails())&&(a=this._getMiscloseDetailsAccordingToPlanSettings(a),this._misCloseDetailsInstance.updateAccordingToPlanSettings(a))},deActivateUpdateRotationPointTool:function(){k.remove(this.updateRotationPointNode,"esriCTEnableButton");g.set(this.updateRotationPointNode,"aria-pressed","false")},deActivateDigitizationTool:function(){k.remove(this.screenDigitizationNode,
"esriCTEnableButton");g.set(this.screenDigitizationNode,"aria-pressed","false")},pointAddedFromDigitization:function(a){var b,c,d,e;e=new x(4326);h.getProjectedGeometry(a,e,this.geometryService).then(f.hitch(this,function(a){b=h.getAngleBetweenPoints(this._startPointForNextLine,a);360===b&&(b=0);c=h.getDistanceBetweenPoints(this._startPointForNextLine,a);d=this.getAngleFromDDTOQB(b);this.bearingNode.set("value",d);"uSSurveyFeet"===this._planSettings.distanceAndLengthUnits&&(c=n.metersToUSSurveyFeet(c));
0<this._scaleValue&&(c/=this._scaleValue);this.lengthNode.set("value",c);this.radiusNode.set("value","");this._addNewItem(!0)}))},getParcelCloseDetails:function(){var a,b,c,d,e,m,g,k,l;d={isClosed:!1,compassStartPoint:null,compassEndPoint:null};e=!0;b=a=c=0;t.forEach(this._itemList,f.hitch(this,function(d,f){d.LineSymbol.type===this.config.BoundaryLineType?(0===c?m=d.startPoint:g=d.endpoint,c++,a+=Math.cos(d.BearingConversions.naDD/180*Math.PI)*d.LengthConversions.meters,b+=Math.sin(d.BearingConversions.naDD/
180*Math.PI)*d.LengthConversions.meters):0<f&&0!==c&&(e=!1)}));1<c&&e&&(k=Math.sqrt(a*a+b*b),k=h.removeNegativeExponents(k),m.x=n.showFixedPlacesAfterDecimal(m.x,6),m.y=n.showFixedPlacesAfterDecimal(m.y,6),g.x=n.showFixedPlacesAfterDecimal(g.x,6),g.y=n.showFixedPlacesAfterDecimal(g.y,6),l=h.getAngleBetweenPoints(g,m),d.isClosed=!0,d.compassStartPoint=m,d.compassEndPoint=g,d.miscloseDistance=k,d.miscloseBearing=l);return d},setParcelClosure:function(a,b){var c;c=this.getParcelCloseDetails();if(c.isClosed)c=
this.getCalculatedMiscloseDetails(c),this._misCloseDetailsInstance.setMiscloseDetails(c),c.adjustPoints?((this.adjustPoints=this._applyCompassRule(c))&&!this.appliedCompassRule||a)&&this.setStartPoint(this.startPoint,b):(this.adjustPoints=!1,(this.appliedCompassRule||a)&&this.setStartPoint(this.startPoint,b));else if(this._misCloseDetailsInstance.setMiscloseDetails(null),this.adjustPoints=!1,this.appliedCompassRule||a)this.appliedCompassRule=!1,this.setStartPoint(this.startPoint,b)},_getMiscloseDetailsAccordingToPlanSettings:function(a){var b,
c;b={};a.BearingConversions&&(b.miscloseBearing=this._getBearingAccordingToPlanSettings(a.BearingConversions));c=this._getRoundedValue(a.LengthConversions,"MiscloseDistance");b.miscloseDistance=c+" "+this._getAbbreviatedUnits(this._planSettings.distanceAndLengthUnits);a.AreaConversions?(a=a.AreaConversions[this._planSettings.areaUnits],isNaN(parseFloat(a))||(a=n.honourPopupRounding(2,a.toFixed(1)))):a=0;a=a+" "+this._getAbbreviatedUnits(this._planSettings.areaUnits);b.calculatedArea=a;return b},getCalculatedMiscloseDetails:function(a){var b,
c={},d=b=0,d=0,e=!1;b=a.compassStartPoint;if(a.compassEndPoint&&b){b=a.miscloseDistance;d=a.miscloseBearing;0===b&&(d=0);d=this.getAngleFromDDTOQB(d);if(a=n.categorizeBearingFormat(d,this._planSettings))c.BearingConversions=a;c.AreaConversions=this._getCalculatedArea();a=this._getMiscloseRatioInfo(b);d=a.miscloseRatio;c.miscloseValue=a.miscloseValue;b=n.categorizeLengthFormat(b,"meters");c.LengthConversions=b;b=b[this.config.miscloseSnapDistanceUnit+"Round"];1E5<=d&&(e=!0);c.miscloseRatio=d;c.accuracy=
e;c=f.mixin(c,this._getMiscloseDetailsAccordingToPlanSettings(c));if(0<b&&b<=this.config.miscloseSnapDistance||isFinite(d)&&d>=this.config.miscloseRatioSnap)c.adjustPoints=!0,c.compassCompleteLength=a.compassCompleteLength}return c},_getPolygonAtOrigin:function(){var a=new R(0,0,new x(4326)),b=[];t.forEach(this._itemList,f.hitch(this,function(c){var d,e;if(c.LineSymbol.type===this.config.BoundaryLineType){if(""===c.Radius||"0"===c.Radius||0===c.Radius){if(c.adjustedValues&&this.adjustPoints){e=c.adjustedValues.adjustedBearing;
if("S"===c.BearingConversions.qb3DDRound.charAt(0)||0>c.adjustedValues.lat)e=c.adjustedValues.adjustedBearingNADD;d=c.adjustedValues.adjustedLength}else e=c.BearingConversions.naDD,d=c.LengthConversions.meters;c=h.getDestinationPoint(a,e,d);d=h.getLineBetweenPoints([a,c])}else{if(c.adjustedValues&&this.adjustPoints){e=c.adjustedValues.adjustedBearing;if("S"===c.BearingConversions.qb3DDRound.charAt(0)||0>c.adjustedValues.lat)e=c.adjustedValues.adjustedBearingNADD;d=c.adjustedValues.adjustedLength;
0>c.ChordLengthConversions.meters&&(d*=-1)}else e=c.BearingConversions.naDD,d=c.ChordLengthConversions.meters;d=this.getArcInfo(a,e,c.RadiusConversions.meters,d);c=d.endPoint;d=h.getLineBetweenPoints(d.arcGeometryPointsArray)}a=c;for(c=0;c<d.paths.length;c++)b.push(d.paths[c])}}));return h.getPolygonFromPolyLines(b,!0)},_getCalculatedArea:function(){var a,b;this._arrayOfAllBoundaryLines&&0<this._arrayOfAllBoundaryLines.length&&(b=this._getPolygonAtOrigin())&&(a=new u(b),this.parcelPolygonGraphicsLayer.clear(),
this.parcelPolygonGraphicsLayer.add(a),a=h.getAreaOfGeometry(b));return a},_applyCompassRule:function(a){var b,c,d,e,f,g;f=e=0;g={};for(d=0;d<this._itemList.length;d++)c=this._itemList[d],c.LineSymbol.type===this.config.BoundaryLineType&&(""===c.Radius||"0"===c.Radius||0===c.Radius?b=c.LengthConversions.meters:c.ChordLengthConversions&&(b=c.ChordLengthConversions.meters),b=Math.abs(b),c.lat=b*Math.cos(Math.PI/180*c.BearingConversions.naDD),c.dep=b*Math.sin(Math.PI/180*c.BearingConversions.naDD),e+=
c.lat,f+=c.dep);g.sumOfLat=e;g.sumOfDep=f;g.sumOfAllLinesLength=a.compassCompleteLength;for(d=0;d<this._itemList.length;d++)c=this._itemList[d],""===c.Radius||"0"===c.Radius||0===c.Radius?b=c.LengthConversions.meters:c.ChordLengthConversions&&(b=c.ChordLengthConversions.meters),b=Math.abs(b),c.LineSymbol.type===this.config.BoundaryLineType&&(c.adjustedValues=this._adjustBearingAndDistance(c.lat,c.dep,b,g));for(d=b=a=0;d<this._itemList.length;d++)c=this._itemList[d],c.LineSymbol.type===this.config.BoundaryLineType&&
(a+=parseFloat(c.adjustedValues.lat.toFixed(2)),b+=parseFloat(c.adjustedValues.dep.toFixed(2)),a=parseFloat(a.toFixed(2)),b=parseFloat(b.toFixed(2)));return 0===parseInt(a,10)&&0===parseInt(b,10)?!0:!1},_adjustBearingAndDistance:function(a,b,c,d){var e,f;e={};a=parseFloat(a.toFixed(6));b=parseFloat(b.toFixed(6));c=parseFloat(c.toFixed(6));f=-d.sumOfLat/d.sumOfAllLinesLength*c;c*=-d.sumOfDep/d.sumOfAllLinesLength;f=parseFloat(f.toFixed(6));c=parseFloat(c.toFixed(6));b+=c;a=parseFloat((a+f).toFixed(6));
b=parseFloat(b.toFixed(6));f=Math.sqrt(Math.pow(a,2)+Math.pow(b,2));c=Math.atan(b/a);c=parseFloat(c.toFixed(6));e.lat=a;e.dep=b;e.adjustedLength=f;e.adjustedBearing=180/Math.PI*c;a=n.categorizeBearingFormat(e.adjustedBearing,{directionOrAngleType:"southAzimuth",directionOrAngleUnits:"decimalDegree"});e.adjustedBearingNADD=a.naDD;return e},_getMiscloseRatioInfo:function(a){var b,c=b=0,d;d=0;this._arrayOfAllBoundaryLines&&0<this._arrayOfAllBoundaryLines.length&&(b=h.getPolyLineFromPaths(this._arrayOfAllBoundaryLines),
b=h.getLengthOfGeometry(b),0<b&&(c=1/(a/b),10>c?c=0:1E5>c&&(d=parseInt(c,10),c="1:"+parseInt(c,10))));return{miscloseRatio:c,miscloseValue:d,compassCompleteLength:b}},getAngleFromDDTOQB:function(a){var b,c;c=f.clone(this._planSettings);c.directionOrAngleType="northAzimuth";c.directionOrAngleUnits="decimalDegree";(a=n.categorizeBearingFormat(a,c))&&(b="degreeMinuteSeconds"===this._planSettings.directionOrAngleUnits?a.qb3DMS:a.qb3DD);return b},initEditing:function(a,b,c){var d,e,g,k,l;this._planInfoInstance.setParcelInformation(this.polygonDeleteArr,
b.features);d=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.rotation.name];(g=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.scale.name])||(g=1);e=this.polygonDeleteArr[0].attributes[this.config.polygonLayer.statedArea.name];this._parcelToolInstance.setRotation(d);this._parcelToolInstance.setScale(g);null!==e&&void 0!==e&&this._misCloseDetailsInstance.traverseStatedArea.set("value",e);g=[];k=h.getUnitValueForSR(c);l=f.clone(this._planSettings);l.directionOrAngleType="northAzimuth";
l.directionOrAngleUnits="decimalDegree";for(c=0;c<b.features.length;c++){d={};d.Bearing=b.features[c].attributes[this.config.polylineLayer.bearing.name];d.BearingConversions=n.categorizeBearingFormat(d.Bearing,l);d.Bearing=this._getBearingAccordingToPlanSettings(d.BearingConversions,!0);d.Length=b.features[c].attributes[this.config.polylineLayer.distance.name];null!==d.Length&&""!==d.Length&&(d.LengthConversions=this._validateLength(d.Length,k),d.Length=d.LengthConversions[this._planSettings.distanceAndLengthUnits]);
if(e=this.getLineSymbolForType(b.features[c].attributes[this.config.polylineLayer.lineType.name]))d.LineSymbol=e;d.Radius=b.features[c].attributes[this.config.polylineLayer.radius.name];null!==d.Radius&&""!==d.Radius?(d.RadiusConversions=this._validateLength(d.Radius,k),d.Radius=d.RadiusConversions[this._planSettings.distanceAndLengthUnits],d.ArcLength=b.features[c].attributes[this.config.polylineLayer.arcLength.name],null!==d.ArcLength&&""!==d.ArcLength&&(d.ArcLengthConversions=this._validateLength(d.ArcLength,
k),d.ArcLength=d.ArcLengthConversions[this._planSettings.distanceAndLengthUnits]),d.ChordLength=b.features[c].attributes[this.config.polylineLayer.chordLength.name],null!==d.ChordLength&&""!==d.ChordLength&&(d.ChordLengthConversions=this._validateLength(d.ChordLength,k),d.ChordLength=d.ChordLengthConversions[this._planSettings.distanceAndLengthUnits]),"radiusAndArcLength"===this._planSettings.circularCurveParameters?(d.Length=d.ArcLength,d.LengthConversions=f.clone(d.ArcLengthConversions)):(d.Length=
d.ChordLength,d.LengthConversions=f.clone(d.ChordLengthConversions))):(d.Radius="",d.RadiusConversions=null);g.push(d)}this._itemList=g;this._reGenerateTraverseGrid();this._showHideTraverseTools();this.setStartPoint(a,!0);this.setBoundaryLineSymbol()},setBoundaryLineSymbol:function(){this._symbolSelector&&t.some(this.config.lineTypes,f.hitch(this,function(a){if(this.config.BoundaryLineType===a.type)return this._symbolSelector.selectSymbol(a),!1}))},getLineSymbolForType:function(a){var b;t.some(this.config.lineTypes,
f.hitch(this,function(c){if(c.type===a)return b=f.clone(c),!0}));return b},deactivateParcelTools:function(){this._parcelToolInstance.disableRotating();this._parcelToolInstance.disableScaling()},clearAll:function(){this.parcelLinesGraphicsLayer.clear();this.parcelPointsGraphicsLayer.clear();this.parcelPolygonGraphicsLayer.clear();this.rotationPointsGraphicsLayer.clear();this._resetEntryRow();this._dndContainer.clearItems();q.empty(this.traverseGrid);this._itemList=[];this._nodes=[];this._showHideTraverseTools();
this._orgStartPointForNextLine=this._startPointForNextLine=this.startPoint=null;this._rotationAngle=0;this._scaleValue=1;this._symbolSelector.setDefault();k.remove(this.screenDigitizationNode,"esriCTEnableButton");k.remove(this.updateRotationPointNode,"esriCTEnableButton");this._parcelToolInstance.resetTools();this.deactivateParcelTools();this._misCloseDetailsInstance.setMiscloseDetails(null);this._arrayOfAllBoundaryLines=[];this.polygonDeleteArr=[];this.polylineDeleteArr=[];this.domNode.scrollTop=
0;this._planInfoInstance.resetValues();this._misCloseDetailsInstance.traverseStatedArea.set("value",null);this._rotationPointInfo=null;this.closePopup()},_showParcelPopup:function(a){var b,c,d=[];b=new P;c=this._pointToExtent(a.mapPoint,8);d=t.filter(this.parcelLinesGraphicsLayer.graphics,function(a){return c.intersects(a.geometry)});d[0]?(this._createPopupContent(a,d[0]),b.resolve(!0)):(this.closePopup(),b.resolve(!1));return b},_getAbbreviatedUnits:function(a){return window.jimuNls.units[a+"Abbr"]},
_pointToExtent:function(a,b){var c;c=this.map.extent.getWidth()/this.map.width;b*=c;return new Q(a.x-b,a.y-b,a.x+b,a.y+b,this.map.spatialReference)},_createPopupContent:function(a,b){var c,d,e;if(e=this._itemList[b.attributes.rowIndex])c=q.create("div",{"class":"esriCTParcelInfoPopup "+this.baseClass},null),d=q.create("div",{"class":"esriCTLabelRows"},c),this._createFieldLabels(d,this.nls.traverseSettings.bearingLabel),this._createFieldLabels(d,this.nls.traverseSettings.lengthLabel),this._createFieldLabels(d,
this.nls.traverseSettings.radiusLabel),b=q.create("div",{"class":"esriCTRowContainer esriCTRow",rowIndex:b.attributes.rowIndex},c),this._createFieldInputs(b,this._getBearingAccordingToPlanSettings(e.BearingConversions),"esriCTBearingRow",!0),(d=e.RadiusConversions)?(d=this._getRoundedValue(e.RadiusConversions,"Radius"),e="radiusAndArcLength"===this._planSettings.circularCurveParameters?this._getRoundedValue(e.ArcLengthConversions,"Length"):this._getRoundedValue(e.ChordLengthConversions,"Length")):
(d="",e=this._getRoundedValue(e.LengthConversions,"Length")),this._createFieldInputs(b,e,"esriCTLengthRow",!0),this._createFieldInputs(b,d,"esriCTRadiusRow",!0),z.position(this.traverseEntryNode)&&z.position(this.traverseEntryNode).w&&(e=z.position(this.traverseEntryNode).w-42,A.set(this._popupDialog.domNode,"width",e+"px")),this._popupDialog.setContent(c),this._popupCoords={pageX:a.pageX,pageY:a.pageY},this._openPopup(a)},_openPopup:function(a){A.set(this._popupDialog.domNode,"opacity",.9);B.open({popup:this._popupDialog,
x:a.pageX,y:a.pageY})},closePopup:function(){this._popupDialog&&B.close(this._popupDialog)},_createFieldLabels:function(a,b){q.create("div",{innerHTML:b,title:b,"class":"esriCTParcelInfoLabels"},a)},_createTooltip:function(){this._popupDialog=new O({"class":"esriCTEditParcelDialog"});this._popupDialog.startup()},validateNumericField:function(a,b){var c,d=/^[-+]?[0-9]+\.[0-9]+$/,e=/^[-+]?[0-9]+$/;a=f.trim(a);switch(b){case "esriFieldTypeSmallInteger":b=parseInt(a,10);c=a.match(e)&&-32768<=b&&32767>=
b&&0!==a.length?!0:!1;break;case "esriFieldTypeInteger":b=parseInt(a,10);c=a.match(e)&&-2147483648<=b&&2147483647>=b&&0!==a.length?!0:!1;break;case "esriFieldTypeSingle":b=parseFloat(a);c=(a.match(e)||a.match(d))&&b>=-3.4*Math.pow(10,38)&&b<=1.2*Math.pow(10,38)&&0!==a.length?!0:!1;break;case "esriFieldTypeDouble":b=parseFloat(a),c=(a.match(e)||a.match(d))&&b>=-2.2*Math.pow(10,308)&&b<=1.8*Math.pow(10,38)&&0!==a.length?!0:!1}return c},updateLastNodeInTraversePanel:function(){this._planInfoInstance.setPlanInfoCancelBtnAsLastNode()},
_showParcelSavedAndDeleteMsg:function(a){this.emit("showParcelSavedAndDeleteMsg",a)}})});